<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Espace Gestionnaire - Test Messages</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    input, textarea { display: block; margin-bottom: 10px; width: 300px; padding: 5px; }
    button { padding: 5px 10px; }
    #confirmation { font-weight: bold; margin-top: 10px; }
    #messagesList li { margin-bottom: 5px; }
  </style>
</head>
<body>
  <h1>Espace Gestionnaire - Test Messages</h1>

  <button id="btnTestConnexion">Tester la connexion au serveur</button>
  <p id="testResult"></p>

  <h2>Messages existants</h2>
  <ul id="messagesList"></ul>

  <h3>Envoyer un message à un commercial</h3>
  <form id="formMessage">
    <label><input type="checkbox" id="toSquad"> Envoyer à toute la squad</label>
    <input type="text" id="squad" placeholder="Nom de la squad (ex: A)" style="display:none;margin-bottom:8px">
    <input type="number" id="dest" placeholder="ID commercial" required>
    <input type="text" id="titre" placeholder="Titre" required>
    <textarea id="contenu" placeholder="Message" required></textarea>
    <button type="submit">Envoyer</button>
  </form>
  <p id="confirmation"></p>

  <script>
    const token = localStorage.getItem('token');
    if (!token) {
      alert('Aucun token trouvé dans localStorage ! Connectez-vous d’abord.');
    }


    // --- Charger les messages existants ---
    async function loadMessages() {
      try {
        const res = await fetch('http://localhost:3000/api/message/', {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        if (!res.ok) throw new Error('Erreur ' + res.status);
        const body = await res.json();
        const messages = Array.isArray(body) ? body : (body && body.data ? body.data : []);
        const list = document.getElementById('messagesList');
        list.innerHTML = '';
        if (messages.length === 0) {
          list.innerHTML = '<li>Aucun message</li>';
          return;
        }
        messages.forEach(msg => {
          const li = document.createElement('li');
          li.textContent = `[${msg.dateEnvoi || ''}] ${msg.titre}: ${msg.contenu} ${msg.lu ? '(Lu)' : '(Non lu)'}`;
          list.appendChild(li);
        });
      } catch (err) {
        console.error('Erreur fetch messages:', err);
        document.getElementById('messagesList').innerHTML = '<li>Impossible de charger les messages</li>';
      }
    }

    loadMessages();

    // --- Envoi d'un message ---
    document.getElementById('formMessage').addEventListener('submit', async (e) => {
      e.preventDefault();
      const toSquad = document.getElementById('toSquad').checked;
      const squad = document.getElementById('squad').value.trim();
      const idDest = document.getElementById('dest').value;
      const titre = document.getElementById('titre').value;
      const contenu = document.getElementById('contenu').value;
      const confirmation = document.getElementById('confirmation');

      try {
        const bodyData = toSquad ? { squad, titre, contenu } : { idDestinataire: idDest, titre, contenu };
        const res = await fetch('http://localhost:3000/api/message/send', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': 'Bearer ' + token
          },
          body: JSON.stringify(bodyData)
        });
        const body = await res.json();
        if (res.ok && body && body.ok) {
          confirmation.style.color = 'green';
          if (toSquad) {
            confirmation.textContent = `Message envoyé à la squad ${squad} (${body.data && body.data.insertedCount ? body.data.insertedCount : 'OK'})`;
          } else {
            confirmation.textContent = `Message envoyé au commercial ID ${idDest} !`;
          }
          e.target.reset();
          loadMessages();
        } else {
          const msg = body && body.message ? body.message : (body && typeof body === 'string' ? body : 'Inconnue');
          confirmation.style.color = 'red';
          confirmation.textContent = `Erreur : ${msg}`;
        }
      } catch (err) {
        console.error(err);
        confirmation.style.color = 'red';
        confirmation.textContent = 'Erreur serveur ou connexion impossible';
      }
    });

    // toggle squad input
    document.getElementById('toSquad').addEventListener('change', (e) => {
      const checked = e.target.checked;
      document.getElementById('squad').style.display = checked ? 'block' : 'none';
      document.getElementById('dest').disabled = checked;
      if (checked) document.getElementById('dest').value = '';
    });
  </script>
</body>
</html>
